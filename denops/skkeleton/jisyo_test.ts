import { dirname, fromFileUrl, join } from "./deps/std/path.ts";
import { assertEquals } from "./deps/std/testing.ts";
import {
  Library,
  load as loadJisyo,
  SKKDictionary,
  UserDictionary,
  wrapDictionary,
} from "./jisyo.ts";
import { readFileWithEncoding } from "./util.ts";

const globalJisyo = join(
  dirname(fromFileUrl(import.meta.url)),
  "testdata",
  "globalJisyo",
);

const globalJisyo2 = join(
  dirname(fromFileUrl(import.meta.url)),
  "testdata",
  "globalJisyo2",
);

const numJisyo = join(
  dirname(fromFileUrl(import.meta.url)),
  "testdata",
  "numJisyo",
);

const numIncludingJisyo = join(
  dirname(fromFileUrl(import.meta.url)),
  "testdata",
  "numIncludingJisyo",
);

async function load(path: string, encoding: string): Promise<SKKDictionary> {
  const dic = new SKKDictionary();
  dic.load(await readFileWithEncoding(path, encoding));
  return dic;
}

Deno.test({
  name: "get candidates",
  async fn() {
    const jisyo = await load(globalJisyo, "euc-jp");
    const manager = new Library([jisyo]);
    const ari = await manager.getCandidate("okuriari", "„Å¶„Åôt");
    assertEquals(["„ÉÜ„Çπ„Éà"], ari);
    const nasi = await manager.getCandidate("okurinasi", "„Å¶„Åô„Å®");
    assertEquals(nasi, ["„ÉÜ„Çπ„Éà", "test"]);
  },
});

Deno.test({
  name: "get num candidates",
  async fn() {
    const jisyo = wrapDictionary(await load(numJisyo, "euc-jp"));
    const manager = new Library([jisyo]);
    const nasi = await manager.getCandidate("okurinasi", "101„Å∞„Çì");
    assertEquals(nasi, [
      "101Áï™",
      "ÔºëÔºêÔºëÁï™",
      "‰∏Ä„Äá‰∏ÄÁï™",
      "Áôæ‰∏ÄÁï™",
      "CIÁï™",
      "‰Ω∞Â£±Áï™",
    ]);
  },
});

Deno.test({
  name: "get num candidates (Kifu)",
  async fn() {
    const jisyo = wrapDictionary(await load(numJisyo, "euc-jp"));
    const manager = new Library([jisyo]);
    const nasi1 = await manager.getCandidate("okurinasi", "11„Åä„ÅÜ„Å¶");
    assertEquals(nasi1, ["Ôºë‰∏ÄÁéãÊâã"]);
    const nasi2 = await manager.getCandidate("okurinasi", "111„Åä„ÅÜ„Å¶");
    assertEquals(nasi2, ["111ÁéãÊâã"]);
  },
});

Deno.test({
  name: "get candidates from words that include numbers",
  async fn() {
    const jisyo = wrapDictionary(await load(numIncludingJisyo, "utf-8"));
    const manager = new Library([jisyo]);
    const nasi1 = await manager.getCandidate("okurinasi", "cat2");
    assertEquals(nasi1, ["üêà"]);
    const nasi2 = await manager.getCandidate("okurinasi", "1000001");
    assertEquals(nasi2, ["Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫ÂçÉ‰ª£Áî∞"]);
  },
});

Deno.test({
  name: "register candidate",
  async fn() {
    const manager = new Library();
    // most recently registered
    await manager.registerCandidate("okurinasi", "test", "a");
    await manager.registerCandidate("okurinasi", "test", "b");
    assertEquals(["b", "a"], await manager.getCandidate("okurinasi", "test"));
    // and remove duplicate
    await manager.registerCandidate("okurinasi", "test", "a");
    assertEquals(["a", "b"], await manager.getCandidate("okurinasi", "test"));
  },
});

Deno.test({
  name: "global/local jisyo interop",
  async fn() {
    const jisyo = await load(globalJisyo, "euc-jp");
    const library = new Library([jisyo]);
    await library.registerCandidate("okurinasi", "„Å¶„Åô„Å®", "test");

    // remove dup
    const nasi = await library.getCandidate("okurinasi", "„Å¶„Åô„Å®");
    assertEquals(["test", "„ÉÜ„Çπ„Éà"], nasi);

    // new candidate
    // user candidates priority is higher than global
    await library.registerCandidate("okurinasi", "„Å¶„Åô„Å®", "„Å¶„Åô„Å®");
    const nasi2 = await library.getCandidate("okurinasi", "„Å¶„Åô„Å®");
    assertEquals(["„Å¶„Åô„Å®", "test", "„ÉÜ„Çπ„Éà"], nasi2);
  },
});

Deno.test({
  name: "read/write skk jisyo",
  async fn() {
    const tmp = await Deno.makeTempFile();
    try {
      await Deno.writeTextFile(
        tmp,
        `
;; okuri-ari entries.
;; okuri-nasi entries.
„ÅÇ /„ÅÇ/
      `,
      );

      // load
      const dic = new UserDictionary();
      await dic.load({ path: tmp });
      assertEquals(await dic.getCandidate("okurinasi", "„ÅÇ"), ["„ÅÇ"]);

      //save
      dic.registerCandidate("okurinasi", "„ÅÇ", "‰∫ú");
      await dic.save();
      const data = await Deno.readTextFile(tmp);
      const line = data.split("\n").find((value) => value.startsWith("„ÅÇ"));
      assertEquals(line, "„ÅÇ /‰∫ú/„ÅÇ/");
    } finally {
      await Deno.remove(tmp);
    }
  },
});

Deno.test({
  name: "don't register empty candidate",
  async fn() {
    const dic = new UserDictionary();
    dic.registerCandidate("okurinasi", "„Åª„Åí", "");
    dic.registerCandidate("okuriari", "„Åª„Åí", "");
    assertEquals(
      await dic.getCandidate("okurinasi", "„Åª„Åí"),
      [],
    );
    assertEquals(
      await dic.getCandidate("okuriari", "„Åª„Åí"),
      [],
    );
  },
});

Deno.test({
  name: "getRanks",
  async fn() {
    // „É©„É≥„ÇØ„ÅØ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÅüÈ†ÜÂ∫è„ÅÇ„Çã„ÅÑ„ÅØÁôªÈå≤„Åï„Çå„ÅüÊôÇÂàª„ÅßË°®„Åï„Çå„Çã
    // ÈÅ©Âàá„Å´ÊØîËºÉ„Åô„Çã„Å®ÊúÄËøëÁôªÈå≤„Åó„ÅüÁâ©„Åª„Å©ÂÖàÈ†≠„Å´‰∏¶„Å∂„Çà„ÅÜ„Å´„ÇΩ„Éº„Éà„Åß„Åç„Çã
    // ÂÄôË£ú„ÅØgetCandidates„ÅÆÁµêÊûú„Å´„Çà„Çä„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åï„Çå„Çã
    const dic = new UserDictionary();
    dic.registerCandidate("okurinasi", "„Åª„Åí", "hoge");
    dic.registerCandidate("okurinasi", "„Å¥„Çà", "piyo");
    await new Promise((r) => setTimeout(r, 2));
    dic.registerCandidate("okurinasi", "„Åª„Åí„Åª„Åí", "hogehoge");
    const a = dic.getRanks("„Åª„Åí")
      .sort((a, b) => b[1] - a[1])
      .map((e) => e[0]);
    assertEquals(a, ["hogehoge", "hoge"]);

    await new Promise((r) => setTimeout(r, 2));
    dic.registerCandidate("okurinasi", "„Åª„Åí", "hoge");
    const b = dic.getRanks("„Åª„Åí")
      .sort((a, b) => b[1] - a[1])
      .map((e) => e[0]);
    assertEquals(b, ["hoge", "hogehoge"]);

    const c = dic.getRanks("„Å¥„Çà")
      .map((e) => e[0]);
    assertEquals(c, ["piyo"]);
  },
});

Deno.test({
  name: "multi dictionary",
  async fn() {
    const lib = await loadJisyo([
      [globalJisyo, "euc-jp"],
      [globalJisyo2, "utf-8"],
    ], {});
    assertEquals(await lib.getCandidate("okurinasi", "„Å¶„Åô„Å®"), [
      "„ÉÜ„Çπ„Éà",
      "test",
      "ÔæÉÔΩΩÔæÑ",
    ]);
    assertEquals(await lib.getCandidate("okurinasi", "„ÅÇ"), ["a"]);
    assertEquals(await lib.getCandidate("okurinasi", "„ÅÑ"), ["i"]);
  },
});
